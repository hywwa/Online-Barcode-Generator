# 在线条形码生成器

这是一个基于Node.js和Express开发的在线条形码生成工具，支持自定义条码内容、宽度和高度，以及安全的验证码系统和灵活的条码参数设置。该系统采用分层设计，确保了良好的安全性、可扩展性和用户体验。

## 目录

- [功能特性](#功能特性)
  - [基础功能](#基础功能)
  - [安全验证码系统](#安全验证码系统)
  - [高级条码参数设置](#高级条码参数设置)
- [技术架构](#技术架构)
- [系统流程](#系统流程)
- [核心配置](#核心配置)
- [路由结构](#路由结构)
- [API 文档](#api-文档)
- [安全机制](#安全机制)
- [安装与运行](#安装与运行)
  - [环境要求](#环境要求)
  - [安装步骤](#安装步骤)
  - [开发模式](#开发模式)
  - [生产模式](#生产模式)
- [部署说明](#部署说明)
  - [部署到腾讯云](#部署到腾讯云)
  - [PM2进程管理](#pm2进程管理)
- [使用指南](#使用指南)
  - [管理员操作](#管理员操作)
  - [普通用户操作](#普通用户操作)
  - [条码参数设置](#条码参数设置)
- [常见问题](#常见问题)
- [许可证](#许可证)

## 功能特性

### 基础功能

- **自定义条码生成**：支持输入任意文本内容生成条码
- **灵活尺寸调整**：可自定义设置条码宽度和高度（毫米单位）
- **高质量输出**：生成600 DPI的PNG格式条码图片
- **批量条码生成**：支持根据总宽度自动生成多个条码
- **响应式设计**：适配桌面端和移动端设备
- **持久化会话**：验证成功后自动创建安全会话,服务端文本记录，浏览器持久化
- **用户隔离**：每个用户拥有独立的配置和会话

### 安全验证码系统

- **四位数数字验证码**：由管理员统一生成，格式为1000-9999
- **严格访问控制**：普通用户必须输入有效验证码才能进入系统
- **多层次防破解机制**：
  - **一次性使用**：每个验证码只能成功验证一次
  - **有效期限制**：支持1小时到7天的灵活设置，默认24小时
  - **尝试次数限制**：每个验证码最多允许5次验证尝试
  - **IP访问限制**：5分钟内超过5次请求则IP被锁定15分钟
  - **自动清理机制**：定期清理过期验证码和会话
- **验证码共享性**：同一验证码可在不同设备使用，但只能验证成功一次

### 高级条码参数设置

- **自定义单个条码宽度**：可精确设置单个条码的宽度
- **调整条码间隙**：自定义条码之间的间距
- **即时生效**：参数修改后立即应用于所有新生成的条码
- **用户独立配置**：每个用户拥有独立的条码配置参数

## 技术架构

### 技术栈

- **后端框架**：Node.js 14+, Express
- **条形码生成库**：bwip-js (Code128格式)
- **图像处理**：pngjs
- **会话管理**：内存存储 + HTTP-Only Cookie
- **日志系统**：自定义日志记录 + morgan
- **进程管理**：PM2（推荐用于生产环境）
- **前端技术**：HTML5, CSS3, JavaScript (ES6+)

### 架构设计

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   客户端浏览器  │────▶│   Express服务器  │────▶│  条形码生成引擎  │
└─────────────────┘     └─────────────────┘     └─────────────────┘
          ▲                       ▲                       ▲
          │                       │                       │
          └───────────────────────┼───────────────────────┘
                                   ▼
                           ┌─────────────────┐
                           │   数据存储层    │
                           │  - 验证码存储   │
                           │  - 会话存储     │
                           │  - IP访问记录   │
                           └─────────────────┘
```

## 系统流程

### 1. 验证码生成流程

1. 管理员通过 `/admin.html` 页面登录（密码：keda666）
2. 输入现场名称和有效期，点击生成验证码
3. 系统生成四位数验证码并存储到验证码数据库
4. 管理员将验证码分发给需要使用系统的用户

### 2. 用户验证流程

1. 普通用户访问系统，自动跳转到 `/verify.html` 验证页面
2. 用户输入收到的四位数验证码
3. 系统验证验证码有效性（格式、是否存在、是否过期、尝试次数）
4. 验证成功：创建安全会话，重定向到 `/index.html` 条码生成页面
5. 验证失败：返回错误信息，记录尝试次数

### 3. 条码生成流程

1. 用户在 `/index.html` 页面输入条码内容和尺寸
2. 点击"生成条码"按钮，发送请求到 `/generate-barcode` API
3. 服务器根据用户配置生成高质量条码图片
4. 浏览器自动下载生成的PNG格式条码图片

## 核心配置

### 验证码系统配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| CODE_LENGTH | Number | 4 | 验证码长度 |
| MAX_ATTEMPTS | Number | 5 | 每个验证码最大尝试次数 |
| DEFAULT_EXPIRY_HOURS | Number | 24 | 默认有效期（小时） |
| MAX_EXPIRY_HOURS | Number | 168 | 最大有效期（7天） |
| RATE_LIMIT_WINDOW_MS | Number | 300000 | 速率限制窗口（5分钟） |
| MAX_REQUESTS_PER_WINDOW | Number | 5 | 每个窗口最大请求数 |
| LOCKOUT_MINUTES | Number | 15 | IP锁定时间（分钟） |
| CLEANUP_INTERVAL_MS | Number | 900000 | 自动清理间隔（15分钟） |

### 条码生成配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| singleBarcodeWidthMm | Number | 50 | 单个条码宽度（毫米） |
| spacingMm | Number | 7.5 | 条码之间的间隙（毫米） |
| sideMarginMm | Number | 8 | 图片两边间距（毫米） |
| DPI | Number | 600 | 输出图片DPI |

## 路由结构

| 路由 | 方法 | 描述 | 访问权限 |
|------|------|------|----------|
| `/` | GET | 根路径，自动重定向到验证或条码页面 | 公开 |
| `/index.html` | GET | 条码生成主页面 | 需要验证 |
| `/verify.html` | GET | 验证码验证页面 | 公开 |
| `/admin.html` | GET | 管理员页面 | 公开（需要密码） |
| `/generate-code` | POST | 生成验证码API | 管理员（需要会话） |
| `/verify-code` | POST | 验证验证码API | 公开 |
| `/generate-barcode` | POST | 生成条码API | 公开 |
| `/set-barcode-config` | POST | 设置条码参数API | 公开（需要密码） |
| `/get-barcode-config` | GET | 获取条码配置API | 公开 |
| `/check-session` | GET | 检查会话状态API | 公开 |
| `/admin-login` | POST | 管理员登录API | 公开 |
| `/admin-status` | GET | 管理员状态检查API | 需要验证 |
| `/logout` | POST | 登出API | 需要验证 |

## API 文档

### 1. 生成验证码

- **URL**: `/generate-code`
- **方法**: `POST`
- **权限**: 管理员（需要有效会话）
- **请求体**:
  ```json
  {
    "siteName": "现场名称",
    "hours": 24,              // 有效期（小时），可选，默认24
    "sessionExpiryDays": 1    // 会话有效期（天），可选
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "code": "1234",
    "expiryTime": 1634567890000
  }
  ```

### 2. 验证验证码

- **URL**: `/verify-code`
- **方法**: `POST`
- **权限**: 公开
- **请求体**:
  ```json
  {
    "code": "1234"
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "message": "验证成功",
    "sessionId": "session_1234567890",
    "redirectUrl": "/"
  }
  ```

### 3. 生成条形码

- **URL**: `/generate-barcode`
- **方法**: `POST`
- **权限**: 公开
- **请求体**:
  ```json
  {
    "text": "条码内容",
    "width": 100,  // 总宽度（毫米）
    "height": 50   // 高度（毫米）
  }
  ```
- **响应**: PNG格式图片文件，自动下载

### 4. 设置条码参数

- **URL**: `/set-barcode-config`
- **方法**: `POST`
- **权限**: 公开（需要密码）
- **请求体**:
  ```json
  {
    "password": "keda",
    "singleBarcodeWidthMm": 50,
    "spacingMm": 7.5
  }
  ```
- **响应**:
  ```json
  {
    "success": true,
    "message": "条码参数设置成功",
    "config": {
      "singleBarcodeWidthMm": 50,
      "spacingMm": 7.5
    }
  }
  ```

## 安全机制

### 1. 验证码安全

- **随机生成**：使用安全的随机数生成器生成验证码
- **唯一性保证**：确保生成的验证码在系统中唯一
- **加密存储**：验证码信息存储在安全的文件系统中
- **自动清理**：定期清理过期验证码，防止信息泄露

### 2. 会话安全

- **HTTP-Only Cookie**：会话ID存储在HTTP-Only Cookie中，防止XSS攻击
- **安全Cookie属性**：
  - `secure`: 生产环境下仅通过HTTPS传输
  - `sameSite`: 防止CSRF攻击
  - `maxAge`: 根据会话有效期动态设置
- **会话隔离**：管理员会话和普通用户会话严格分离
- **定期更新**：每次访问自动更新会话过期时间

### 3. 访问控制

- **IP速率限制**：防止暴力破解和DDoS攻击
- **请求频率监控**：实时记录和分析访问模式
- **异常IP锁定**：自动锁定异常访问的IP地址
- **CORS配置**：严格控制跨域资源访问

### 4. 输入验证

- **类型检查**：验证所有输入参数的类型
- **格式验证**：确保输入符合预期格式
- **范围验证**：限制参数值在合理范围内
- **防注入处理**：对所有输入进行安全过滤

## 安装与运行

### 环境要求

- Node.js (v14.0.0 或更高版本)
- npm (v6.0.0 或更高版本)
- 操作系统：Windows、Linux、macOS

### 安装步骤

1. **克隆或下载项目**
   ```bash
   git clone <repository-url>
   cd barcode-generator
   ```

2. **安装依赖**
   ```bash
   npm install
   ```

### 开发模式

```bash
npm run dev
```

开发模式下，服务器将在 http://localhost:3001 启动，支持热重载。

### 生产模式

```bash
npm start
```

生产模式下，服务器将在 http://localhost:3001 启动，使用优化的配置。

## 部署说明

### 部署到腾讯云

1. **准备工作**
   - 在腾讯云控制台创建云服务器实例
   - 安装Node.js和npm
   - 配置安全组，开放3001端口

2. **上传项目文件**
   -  cd /www/wwwroot/Barcode/dist

3. **安装依赖**
   ```bash
   npm install --production
   ```

4. **配置环境变量**（可选）
   - 可通过环境变量覆盖默认配置
   - 例如：`ADMIN_PASSWORD=your_new_password node server.js`

### PM2进程管理

使用PM2管理Node.js进程是生产环境的推荐做法：

```bash
# 全局安装PM2
npm install -g pm2

# 启动应用
pm2 start server.js --name "barcode"

# 设置开机自启
pm2 startup

# 保存当前进程列表
pm2 save

# 查看应用状态
pm2 status

# 查看应用日志
pm2 logs barcode

# 重启应用
pm2 restart barcode

# 停止应用
pm2 stop barcode
```

## 使用指南

### 管理员操作

1. **登录管理员页面**
   - 访问 `http://localhost:3001/admin.html`
   - 输入密码：`keda666`
   - 点击"登录"按钮

2. **生成验证码**
   - 输入现场名称
   - 设置验证码有效期（可选，默认24小时）
   - 点击"生成验证码"按钮
   - 记录生成的四位数验证码

3. **分发验证码**
   - 将生成的验证码分发给需要使用系统的用户
   - 告知用户验证码的有效期

### 普通用户操作

1. **访问系统**
   - 打开浏览器，访问 `http://localhost:3001`
   - 自动跳转到验证码验证页面

2. **验证验证码**
   - 输入收到的四位数验证码
   - 点击"验证"按钮
   - 验证成功后自动进入条码生成页面

3. **生成条码**
   - 在"条码内容"输入框中输入要生成的文本
   - 设置条码的宽度和高度（毫米）
   - 点击"生成条码"按钮
   - 系统自动生成并下载PNG格式的条码图片

### 条码参数设置

1. **打开设置面板**
   - 在条码生成页面，点击"设置"按钮

2. **调整参数**
   - 设置单个条码的宽度（毫米）
   - 设置条码之间的间隙（毫米）
   - 点击"保存"按钮
   - 新设置将立即应用于所有新生成的条码

## 常见问题

### 1. 验证码无法验证

**可能原因**：
- 验证码已过期
- 验证码已被使用
- 验证码输入错误
- IP已被锁定

**解决方案**：
- 检查验证码是否在有效期内
- 联系管理员获取新的验证码
- 检查输入是否正确（注意大小写和空格）
- 等待15分钟后再次尝试（如果IP被锁定）

### 2. 条码生成失败

**可能原因**：
- 输入内容为空
- 尺寸设置不合理
- 服务器错误

**解决方案**：
- 确保输入了有效的条码内容
- 检查宽度和高度设置是否为正数
- 刷新页面后重新尝试

### 3. 无法访问设置功能

**可能原因**：
- 网络连接问题

**解决方案**：
- 检查网络连接是否正常

### 4. 会话频繁过期

**可能原因**：
- 浏览器关闭了Cookie
- 会话超过了设置的有效期

**解决方案**：
- 确保浏览器允许Cookie
- 联系管理员延长会话有效期

---
